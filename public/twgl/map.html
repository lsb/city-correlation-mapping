<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>web sitelol</title>
    <style>
      canvas {
          display: inline-block;
          width: 256px;//100vw;
          height: 256px;//100vh;
          margin: auto;
      }
      #b {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 2;
      }
    </style>
    <link rel="stylesheet" href="leaflet.css"/>
    <script src="leaflet.js"></script>
    <style>#map { height: 90vh; width: 90vw; }</style>
  </head>
  <body style="background-color:white">
    <canvas id="c" style="visibility:hidden;position:fixed;x:0;y:0"></canvas><br>
    <div id="b">hi lol</div>
    <div>
      here is some text lol
      <canvas id="f1"></canvas>
      <canvas id="f2"></canvas>
      <canvas id="f3"></canvas>
      <canvas id="f4"></canvas><hr>
      <canvas id="f5"></canvas><canvas id="f6"></canvas>
      <hr>
      <canvas id="f22"></canvas>
      <hr><hr>
      <div><div><canvas id="w0"></canvas><canvas id="w1"></canvas></div><div><canvas id="w2"></canvas><canvas id="w3"></canvas></div></div>
    </div>
    <hr><hr><hr>
    <div id="map"></div>
  </body>
  <script id="p30b1vtxboxes" type="notjs">#version 300 es
    in ivec2 p30b1;
    out vec2 frag_pos;
    uniform uint x;
    uniform uint y;
    uniform uint z;
    uniform float rad;
    void main() {
      frag_pos = vec2(sign(p30b1));
      ivec2 pGlobal = ((abs(p30b1) >> (22 - int(z))) - (ivec2(x,y) << 8));
      int irad = int(rad+1.0);
      pGlobal.x += (1 << (int(z)+8)) * ((pGlobal.x > (256 + irad)) ? -1 : ((-irad > pGlobal.x) ? 1 : 0));

      gl_Position = vec4((vec2(pGlobal) + frag_pos * rad)/128.0 * vec2(1.0,-1.0) - vec2(1.0,-1.0), 0.0, 1.0);
    }
  </script>
  <script id="fs" type="notjs">#version 300 es
precision highp float;
uniform float r;
uniform float g;
uniform float b;
uniform float rad;
in vec2 frag_pos;
out vec4 outColor;

void main() {
  float color = 1.0 - smoothstep(0.25/rad, 0.0, 1.0 - length(frag_pos));
  if(color == 0.0) {
    discard;
  } else {
    outColor = vec4( r, g, b, color);
  }
}
  </script>
  <script id="edgeEveryTriangle" type="notjs">#version 300 es
    precision highp int;
    precision highp float;
    in ivec4 edge;
    out vec4 edgeRel;
    uniform uint x;
    uniform uint y;
    uniform uint z;
    uniform float edgeWidth;
    void main() {
      ivec4 unsortedsrcdst = abs(edge) >> (22 - int(z));
      ivec4 srcdst = (unsortedsrcdst.x < unsortedsrcdst.z) ? unsortedsrcdst.xyzw : unsortedsrcdst.zwxy;

      vec4 edgeRelUR = vec4(srcdst - (ivec4(x,y,x,y) << 8));
      vec2 edgeProgressMinMax = smoothstep(0.0, 1.0, smoothstep(edgeRelUR.xx, edgeRelUR.zz, vec2(-0.5-edgeWidth, 0.5+edgeWidth+256.0)));
      vec2 mixedLatitudeMinMax = mix(edgeRelUR.yy, edgeRelUR.ww, edgeProgressMinMax);
      vec2 latRange = mixedLatitudeMinMax.x < mixedLatitudeMinMax.y ? mixedLatitudeMinMax.xy : mixedLatitudeMinMax.yx;
      vec2 lngRange = edgeRelUR.xz + vec2(-edgeWidth, edgeWidth);
      bool edgeInRange = lngRange[0] <= 256.0 && 0.0 <= lngRange[1] && latRange[0] <= 256.0 && 0.0 <= latRange[1];

      gl_Position = !edgeInRange ? vec4(-2.0,-2.0,2.0,1.0) : vec4((edge.y < 0) ? vec2(-1.0,-3.0) : (edge.x < 0 ? vec2(-1.0,3.0) : vec2(2.0,0.0)), 0.0, 1.0);

      edgeRel = edgeRelUR - ((edge.y < 0) ? vec4(0.0, 512.0, 0.0, 512.0) : ((edge.x < 0) ? vec4(0.0, -256.0, 0.0, -256.0) : vec4(384.0, 128.0, 384.0, 128.0)));
    }
  </script>
  <script id="smoothThickEdge" type="notjs">#version 300 es
    precision highp float;
    precision highp int;
    in vec4 edgeRel;
    uniform uint x;
    uniform uint y;
    uniform float edgeR;
    uniform float edgeG;
    uniform float edgeB;
    uniform float edgeWidth;
    uniform float edgeDecayPx;
    uniform float edgeDisappearPx;
    out vec4 outcolor;
    void main() {
      //outcolor = vec4(edgeR, edgeG, edgeB, 0.05); return;
      vec4 sER = sign(edgeRel);
      if(sER.x == sER.z || sER.y == sER.w) { discard; }
      vec2 edgeProgressMinMax = smoothstep(0.0, 1.0, smoothstep(edgeRel.xx, edgeRel.zz, vec2(-0.5-edgeWidth,0.5+edgeWidth)));
      vec2 mixedLatitudeMinMax = mix(edgeRel.yy, edgeRel.ww, edgeProgressMinMax);
      float minLat = (sign(mixedLatitudeMinMax.x) != sign(mixedLatitudeMinMax.y)) ? 0.0 : min(abs(mixedLatitudeMinMax.x), abs(mixedLatitudeMinMax.y));
      float edgeOpacityY = 1.0 - smoothstep(0.5 * edgeWidth, edgeWidth, minLat);
      if(edgeOpacityY == 0.0) { discard; }
      float edgeOpacityX = 1.0 - smoothstep(edgeDecayPx, edgeDisappearPx, min(length(edgeRel.xy), length(edgeRel.zw)));
      if(edgeOpacityX == 0.0) { discard; }
      outcolor = vec4(edgeR, edgeG, edgeB, edgeOpacityX * edgeOpacityY);
    }
  </script>

  <script src="twgl.min.js"></script>
  <script src="places.js"></script>
  <script src="edgeSedgeD.js"></script>
  <script>
    function lng2tile(lon,zoom) {
      return (Math.floor((lon+180)/360*Math.pow(2,zoom)));
    }
    function lat2tile(lat,zoom) {
      return (Math.floor((1-Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 *Math.pow(2,zoom)));
    }
    const maxPlaceId = places.slice(-1)[0][0] + 1;
    used = new Uint8Array(maxPlaceId);
    lat30m = new Uint32Array(maxPlaceId);
    lng30m = new Uint32Array(maxPlaceId);
    titles = [];

    const min_lat_degree = - Math.atan(Math.sinh(Math.PI)) * 180 / Math.PI;
    const max_lat_degree = - min_lat_degree;

    places.forEach(function([id, lat, lng, title]) {
      used[id] = 1;
      lat30m[id] = lat2tile((lat > 0) ? Math.min(max_lat_degree, lat) : Math.max(min_lat_degree, lat), 30);
      lng30m[id] = lng2tile(lng,30);
    });
  </script>
  <script>
    ptc = new Int32Array(lat30m.length * 12); // lng- lat- lng- lat+ lng+ lat+  lng+ lat+ lng+ lat- lng- lat-    lng...
    used.forEach((e,i) => { if(e>0) {
      const lat = lat30m[i];
      const lng = lng30m[i];
      ptc[i*12+0] = ptc[i*12+2] = ptc[i*12+4] = ptc[i*12+6] = ptc[i*12+8] = ptc[i*12+10] = lng;
      ptc[i*12+1] = ptc[i*12+3] = ptc[i*12+5] = ptc[i*12+7] = ptc[i*12+9] = ptc[i*12+11] = lat;
      ptc[i*12+0] *= -1; ptc[i*12+1] *= -1; ptc[i*12+2] *= -1; ptc[i*12+9] *= -1; ptc[i*12+10] *= -1; ptc[i*12+11] *= -1;
    }});
    etc = new Int32Array(edgeS.length * 12); // slng- slat+ dlng dlat sn+ sa+ dn da sn+ sa- dn da  sn- sa+ dn da sn+ sa+ dn da sn+ sa- dn da
    Array.from(edgeS).slice(0,10).forEach((s,i) => {
      const ei = i * 12;
      const d = edgeD[i];
      const sa = lat30m[s];
      const sn = lng30m[s];
      const da = lat30m[d];
      const dn = lng30m[d];
      etc[ei+0] = etc[ei+4] = etc[ei+8] = sn;
      etc[ei+1] = etc[ei+5] = etc[ei+9] = sa;
      etc[ei+2] = etc[ei+6] = etc[ei+10] = dn;
      etc[ei+3] = etc[ei+7] = etc[ei+11] = da;
      etc[ei+0] = -sn;
      etc[ei+9] = -sa;
    });
  </script>
  <script>
    "use strict";
    console.log('hi lol');
    const gl = document.querySelector("#c").getContext("webgl2");
    gl.enable( gl.BLEND );
    gl.blendFuncSeparate( gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA );

    const programInfo = twgl.createProgramInfo(gl, ["p30b1vtxboxes", "fs"]);
    const edgeProgramInfo = twgl.createProgramInfo(gl, ["edgeEveryTriangle","smoothThickEdge"]);
    const arrays = {
      p30b1: {numComponents: 2, data: ptc}
    };
    const bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);

    const edgeArrays = {
      edge: {numComponents: 4, data: etc}
    };
    const edgeBufferInfo = twgl.createBufferInfoFromArrays(gl, edgeArrays);

    function render(xyz, destinationCanvas) {
      const startTime = Date.now();
      twgl.resizeCanvasToDisplaySize(gl.canvas);
      gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

      const uniforms = {
        x: 5,
        y: 12,
        z: 5,
        rad: 8,
        r: 0.375,//0.25,
        g: 0.75,//0.5,
        b: 1,//1,
        edgeR: 0.75,
        edgeG: 0.25,
        edgeB: 0.25,
        edgeWidth: 3,
        edgeDecayPx: 512, // maybe make this proportional to window size lol
        edgeDisappearPx: 1024,
        ...xyz
      };

      gl.useProgram(programInfo.program);
      twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);
      twgl.setUniforms(programInfo, uniforms);
      twgl.drawBufferInfo(gl, bufferInfo, gl.TRIANGLES);
      const shadowTime = Date.now();

      gl.useProgram(edgeProgramInfo.program);
      twgl.setBuffersAndAttributes(gl, edgeProgramInfo, edgeBufferInfo);
      twgl.setUniforms(edgeProgramInfo, uniforms);
      twgl.drawBufferInfo(gl, edgeBufferInfo, gl.TRIANGLES);
      const edgeTime = Date.now();

      gl.useProgram(programInfo.program);
      twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);
      twgl.setUniforms(programInfo, {...uniforms, ...({rad: 1.5, r: 0, g: 0, b: 0})});
      twgl.drawBufferInfo(gl, bufferInfo, gl.TRIANGLES);
      const pointTime = Date.now();
      gl.finish();
      const finishTime = Date.now();
      destinationCanvas.width = gl.canvas.width;
      destinationCanvas.height = gl.canvas.height;
      destinationCanvas.getContext("2d").drawImage(gl.canvas,0,0,gl.canvas.width,gl.canvas.height);
      const copyTime = Date.now();
      console.log({startTime, shadowTime, edgeTime, pointTime, finishTime, copyTime});
      gl.clear(gl.COLOR_BUFFER_BIT);
    }
    requestAnimationFrame(() => render({x:327, y:791, z:11}, document.getElementById("f2")));
    requestAnimationFrame(() => render({x:603, y:769, z:11}, document.getElementById("f3")));
    requestAnimationFrame(() => render({x:5, y:12, z:5}, document.getElementById("f4")));
    requestAnimationFrame(() => render({x:0, y:0, z:0}, document.getElementById("f1")));
    requestAnimationFrame(() => render({x:255, y:141, z:8}, document.getElementById("f5")));
    requestAnimationFrame(() => render({x:0, y:141, z:8}, document.getElementById("f6")));
    requestAnimationFrame(() => render({x:2095652, y:1394698, z:22}, document.getElementById("f22")));

    requestAnimationFrame(() => render({x:0, y:0, z:1}, document.getElementById("w0")));
    requestAnimationFrame(() => render({x:1, y:0, z:1}, document.getElementById("w1")));
    requestAnimationFrame(() => render({x:0, y:1, z:1}, document.getElementById("w2")));
    requestAnimationFrame(() => render({x:1, y:1, z:1}, document.getElementById("w3")));
    setTimeout(() => {
      var map = L.map('map', {
        center: [37.7619, -122.4369],
        zoom: 13,
        maxZoom: 22,
        minZoom: 1,
        zoomSnap: 1,
      });
      var pointOverlay = L.GridLayer.extend({
        createTile: function({x,y,z}) {
          var t = L.DomUtil.create('canvas', 'pOver');
          requestAnimationFrame(() => render({x,y,z}, t));
          return t;
        }
      });
      var yellowboxnumbers = L.GridLayer.extend({createTile: function(coords) { var t = document.createElement('canvas'); var size = this.getTileSize(); t.width = size.x ; t.height = size.y; var ctx = t.getContext('2d'); ctx.font = '0.25in monospace'; setTimeout(() => { ctx.beginPath(); ctx.fillStyle=`rgba(255,255,${0 + Math.floor(Math.random() * 255)},255)`; ctx.rect(0,0,size.x,size.y); ctx.fill();ctx.fillStyle=`black`;ctx.fillText(JSON.stringify([coords.x, coords.y, coords.z]),0,20);},0); return t; }});
      map.addLayer(new yellowboxnumbers());
      map.addLayer(new pointOverlay());
    });
  </script>
</html>
